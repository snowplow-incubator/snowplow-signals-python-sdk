{% raw %}{{ config(
    tags = "snowplow_autogen_incremental",
    materialized = "incremental",
    unique_key = "unique_id",
    upsert_date_key = "collector_tstamp",
    partition_by = snowplow_utils.get_value_by_target_type(
        bigquery_val={
        "field": "collector_tstamp",
        "data_type": "timestamp"
    }, 
    databricks_val='collector_tstamp_date'),
    sql_header=snowplow_utils.set_query_tag(var('snowplow__query_tag', 'snowplow_dbt')),
    tblproperties={
      'delta.autoOptimize.optimizeWrite' : 'true',
      'delta.autoOptimize.autoCompact' : 'true'
    },
    snowplow_optimize=true
) }}

select
    event_id, 
    collector_tstamp,
{% if target.type in ['databricks', 'spark'] -%}
    DATE(collector_tstamp) as collector_tstamp_date,
{%- endif %}
    event_name,
    {% endraw %}
    
    {%- for property in properties %}
        {%- for key, value in property.items() -%}
            '{{ key }}' AS {{ value }}
        {%- endfor %}
        {%- if not loop.last %},{% endif %}
    {% endfor %}

from{% raw %}
    {{ ref('snowplow_autogen_base_events_this_run') }}
where {% endraw %}
    event_name in ('{{ event_names | join("','") }}'){% raw %}
    and {{ snowplow_utils.is_run_with_new_events("snowplow_autogen") }}

{% endraw %}


