# serializer version: 1
# name: test_generated_files
  dict({
    'ecommerce_transaction_interactions_features_1/configs/base_config.json': '''
      {
          "events": [
              "iglu:com.snowplowanalytics.snowplow/page_view/jsonschema/1-0-0"
          ],
          "properties": [
              {
                  "geo_country": "geo_country"
              }
          ],
          "periods": [
              "P7DT0H0M0.000000S"
          ],
          "transformed_attributes": [
              [
                  {
                      "step_type": "filtered_events",
                      "enabled": false,
                      "aggregation": null,
                      "column_name": null,
                      "modeling_criteria": null
                  },
                  {
                      "step_type": "daily_aggregation",
                      "enabled": true,
                      "aggregation": "last",
                      "column_name": "last_geo_country",
                      "modeling_criteria": {
                          "all": [
                              {
                                  "property": "event_name",
                                  "operator": "in",
                                  "value": "'page_view'"
                              }
                          ],
                          "any": []
                      }
                  },
                  {
                      "step_type": "attribute_aggregation",
                      "enabled": true,
                      "aggregation": "last",
                      "column_name": "last_geo_country",
                      "modeling_criteria": {
                          "all": [],
                          "any": []
                      }
                  }
              ],
              [
                  {
                      "step_type": "filtered_events",
                      "enabled": false,
                      "aggregation": null,
                      "column_name": null,
                      "modeling_criteria": null
                  },
                  {
                      "step_type": "daily_aggregation",
                      "enabled": true,
                      "aggregation": "count",
                      "column_name": "count_page_view",
                      "modeling_criteria": {
                          "all": [
                              {
                                  "property": "event_name",
                                  "operator": "in",
                                  "value": "'page_view'"
                              }
                          ],
                          "any": []
                      }
                  },
                  {
                      "step_type": "attribute_aggregation",
                      "enabled": true,
                      "aggregation": "sum",
                      "column_name": "page_view_count_last_7_days",
                      "modeling_criteria": {
                          "all": [
                              {
                                  "property": "period",
                                  "operator": ">",
                                  "value": 7
                              }
                          ],
                          "any": []
                      }
                  }
              ]
          ]
      }
    ''',
    'ecommerce_transaction_interactions_features_1/configs/dbt_config.json': '''
      {
          "filtered_events": {
              "events": [
                  {
                      "event_vendor": "com.snowplowanalytics.snowplow",
                      "event_name": "page_view",
                      "event_format": "jsonschema",
                      "event_version": "1-0-0"
                  }
              ],
              "properties": [
                  {
                      "geo_country": "geo_country"
                  }
              ]
          },
          "daily_agg": {
              "daily_aggregate_attributes": [
                  {
                      "step_type": "daily_aggregation",
                      "aggregation": "count",
                      "column_name": "count_page_view",
                      "condition_clause": "case when  event_name IN('page_view') then 1 else 0 end"
                  }
              ],
              "daily_first_value_attributes": [],
              "daily_last_value_attributes": [
                  {
                      "step_type": "daily_aggregation",
                      "aggregation": "last",
                      "column_name": "last_geo_country",
                      "condition_clause": "geo_country"
                  }
              ]
          },
          "attributes": {
              "lifetime_aggregates": [],
              "last_n_day_aggregates": [
                  {
                      "daily_agg_column_name": "count_page_view",
                      "column_name": "page_view_count_last_7_days",
                      "period": 7,
                      "aggregation_type": "sum"
                  }
              ],
              "first_value_attributes": [],
              "last_value_attributes": [
                  {
                      "daily_agg_column_name": "last_geo_country",
                      "column_name": "last_geo_country",
                      "period": null,
                      "aggregation_type": "last"
                  }
              ]
          }
      }
    ''',
    'ecommerce_transaction_interactions_features_1/dbt_project.yml': '''
      name: 'ecommerce_transaction_interactions_features_1'
      version: '0.0.1'
      config-version: 2
      
      require-dbt-version: [">=1.6.0", "<2.0.0"]
      
      profile: 'snowplow_autogen'
      
      dispatch:
        - macro_namespace: dbt
          search_order: ['snowplow_utils', 'dbt']
      
      model-paths: ["models"]
      analysis-paths: ["analyses"]
      test-paths: ["tests"]
      seed-paths: ["seeds"]
      macro-paths: ["macros"]
      snapshot-paths: ["snapshots"]
      docs-paths: ["docs"]
      
      target-path: "target"
      clean-targets:
        - "target"
        - "dbt_packages"
        - "logs"
        
      models:
        ecommerce_transaction_interactions_features_1:
          +materialized: table
          +file_format:  "{{ 'delta' if target.type not in ['spark'] else 'iceberg'}}"
          +incremental_strategy: "{{ None if target.type not in ['spark'] else 'merge' }}"
          +bind: false
          base:
            +tags: "base"
            manifest:
              +schema: "snowplow_manifest"
            scratch:
              +schema: "scratch"
              +tags: "scratch"
          filtered_events:
            +schema: "derived"
            +tags: "ecommerce_transaction_interactions_features_1_incremental"
            scratch:
              +schema: "scratch"
              +tags: "scratch"
          daily_aggregates:
            +schema: "derived"
            +tags: "ecommerce_transaction_interactions_features_1_incremental"
            scratch:
              +schema: "scratch"
              +tags: "scratch"
            manifest:
              +schema: "snowplow_manifest"
          attributes:
            +schema: "derived"
            +tags: "ecommerce_transaction_interactions_features_1_incremental"
      
      vars:
        ecommerce_transaction_interactions_features_1:
      
          # OPERATION & LOGIC
          
          # filtered_events
          snowplow__start_date: '2025-01-01' # date from where it starts looking for events based on both load and derived_tstamp
          snowplow__app_id: [] # already gets applied in base_events_this_run
          snowplow__backfill_limit_days: 1 # limit backfill increments for the filtered_events_table
          
          # daily_aggregates
          snowplow__late_event_lookback_days: 5 # the number of days to look back when looking for new events compared to the last processed event's session_tstamp in the manifest table, when set to 0 it reprocesses the full day it was last processing 
          snowplow__min_late_events_to_process: 1
          
          snowplow__allow_refresh: false # if true, the manifest will be dropped when running with a --full-refresh flag
      
          # WAREHOUSE & TRACKER
          
          snowplow__events: "{{ source('atomic', 'events') }}"
          snowplow__dev_target_name: dev
          snowplow__databricks_catalog: "hive_metastore"
          snowplow__atomic_schema: 'atomic' # Only set if not using 'atomic' schema for Snowplow events data
          # snowplow__database: # Only set if not using target.database for Snowplow events data -- WILL BE IGNORED FOR DATABRICKS
          # snowplow__events_table: "events" # Only set if not using 'events' table for Snowplow events data
      
      on-run-start:
        - "{{ snowplow_utils.snowplow_delete_from_manifest(var('models_to_remove',[])) }}"
      
      on-run-end:
        - "{{ snowplow_utils.snowplow_incremental_post_hook_t(package_name='ecommerce_transaction_interactions_features_1', incremental_manifest_table_name='ecommerce_transaction_interactions_features_1_incremental_manifest', base_events_this_run_table_name='ecommerce_transaction_interactions_features_1_base_events_this_run') }}"
        - "{{ snowplow_utils.grant_usage_on_schemas_built_into(var('snowplow__grant_schemas', true)) }}"
  
    ''',
    'ecommerce_transaction_interactions_features_1/macros/allow_refresh.sql': '''
      {#
      Copyright (c) 2025-present Snowplow Analytics Ltd. All rights reserved.
      This program is licensed to you under the Snowplow Personal and Academic License Version 1.0,
      and you may not use this file except in compliance with the Snowplow Personal and Academic License Version 1.0.
      You may obtain a copy of the Snowplow Personal and Academic License Version 1.0 at https://docs.snowplow.io/personal-and-academic-license-1.0/
      #}
      
      {# Default: Allow refresh in dev, block refresh otherwise. dev defined by snowplow__dev_target_name #}
      
      {% macro allow_refresh() %}
        {{ return(adapter.dispatch('allow_refresh', 'ecommerce_transaction_interactions_features_1')()) }}
      {% endmacro %}
      
      {% macro default__allow_refresh() %}
      
        {% if flags.FULL_REFRESH == True %}
          {% set allow_refresh = snowplow_utils.get_value_by_target(
                                            dev_value=none,
                                            default_value=var('snowplow__allow_refresh'),
                                            dev_target_name=var('snowplow__dev_target_name')
                                            ) %}
        {% else %}
          {% set allow_refresh = none %}
        {% endif %}
      
        {{ return(allow_refresh) }}
      
      {% endmacro %}
  
    ''',
    'ecommerce_transaction_interactions_features_1/macros/get_cluster_by_values.sql': '''
      {#
      Copyright (c) 2025-present Snowplow Analytics Ltd. All rights reserved.
      This program is licensed to you under the Snowplow Personal and Academic License Version 1.0,
      and you may not use this file except in compliance with the Snowplow Personal and Academic License Version 1.0.
      You may obtain a copy of the Snowplow Personal and Academic License Version 1.0 at https://docs.snowplow.io/personal-and-academic-license-1.0/
      #}
      
      {% macro get_cluster_by_values(model) %}
          {{ return(adapter.dispatch('get_cluster_by_values', 'ecommerce_transaction_interactions_features_1')(model)) }}
      {% endmacro %}
      
      
      {% macro default__get_cluster_by_values(model) %}
          {% if model == 'dummy' %}
              {{ return(snowplow_utils.get_value_by_target_type(bigquery_val=["session_identifier"], snowflake_val=["to_date(start_tstamp)"])) }}
          {% else %}
              {{ exceptions.raise_compiler_error(
            "Snowplow Error: Model "~model~" not defined for cluster by."
            ) }}
          {% endif %}
      {% endmacro %}
  
    ''',
    'ecommerce_transaction_interactions_features_1/macros/get_limits_for_attributes.sql': '''
      {#
      Copyright (c) 2025-present Snowplow Analytics Ltd. All rights reserved.
      This program is licensed to you under the Snowplow Personal and Academic License Version 1.0,
      and you may not use this file except in compliance with the Snowplow Personal and Academic License Version 1.0.
      You may obtain a copy of the Snowplow Personal and Academic License Version 1.0 at https://docs.snowplow.io/personal-and-academic-license-1.0/
      #}
      
      {% macro get_limits_for_attributes() %}
      
      {# upper limit only applies to last n day aggregates in case the user does not want to include current date in the aggregations #}
      {# lower limit is only implemented for reducing unnecessary scans in case there are only last n day aggregate attributes #}
        
        {% set limits_query %}
        
          with base as (
            
            select
              '{{ var('snowplow__start_date', '2025-01-01') }}' as lower_limit,
              coalesce(max(event_date), '{{ var('snowplow__start_date', '2025-01-01') }}') as upper_limit
              
            from {{ ref('ecommerce_transaction_interactions_features_1_daily_aggregates') }}
            
            group by 1
          )
          
          , upper_limit_changes as (
            
            select
              lower_limit,
              {% if not var('snowplow__include_current_day_in_windows', false) %} 
                case when upper_limit = current_date then {{dbt.dateadd('day', -1, "'"~upper_limit~"'")}} else upper_limit end as upper_limit
              {% else %}
                upper_limit
              {% endif %}
              
            from base
          )
          
          select
            lower_limit,
            upper_limit
      
          from upper_limit_changes
      
        {% endset %}
      
        {% set limit_results = run_query(limits_query)%}
      
        {% if execute %}
          {% if limit_results|length == 0  %}
            {{ exceptions.raise_compiler_error("Error: No limits returned") }}
          {% else %}
            {% set lower_limit = "'"~limit_results.columns[0].values()[0]~"'" %}
            {% set upper_limit = "'"~limit_results.columns[1].values()[0]~"'" %}
            {{ log(this.table ~ ": processing daily events between " ~ lower_limit ~ " and " ~ upper_limit, info=write_limits_to_stdout) }}
            {{ return([lower_limit, upper_limit]) }}
          {% endif %}
        {% else%}
          {{ return(['','']) }}
        {% endif %}
      
      {% endmacro %}
  
    ''',
    'ecommerce_transaction_interactions_features_1/models/attributes/ecommerce_transaction_interactions_features_1_attributes.sql': '''
      
      {#
      Copyright (c) 2025-present Snowplow Analytics Ltd. All rights reserved.
      This program is licensed to you under the Snowplow Personal and Academic License Version 1.0,
      and you may not use this file except in compliance with the Snowplow Personal and Academic License Version 1.0.
      You may obtain a copy of the Snowplow Personal and Academic License Version 1.0 at https://docs.snowplow.io/personal-and-academic-license-1.0/
      #}
      
      {{
        config(
          materialized='table',
          dist='domain_userid',
          partition_by = snowplow_utils.get_value_by_target_type(bigquery_val = {
            "field": "last_event_tstamp",
            "data_type": "timestamp"
          }, databricks_val='last_event_date'),
          sql_header=snowplow_utils.set_query_tag(var('snowplow__query_tag', 'snowplow_dbt')),
        )
      }}
      
      {%- set lower_limit, upper_limit = get_limits_for_attributes() %}
      
      with aggregations as (
      
        select 
          domain_userid
      
          
          
            , sum(case when event_date >= {{dbt.dateadd('day', -7, upper_limit)}} then count_page_view end) as page_view_count_last_7_days
          
      
      
        from {{ ref('ecommerce_transaction_interactions_features_1_daily_aggregates')}}
      
        group by 1
        
      )
      
      , window_calculations as (
        
        select distinct
          domain_userid
      
      
      
        
          , last_value(last_geo_country) over (
                      partition by domain_userid 
                      order by last_event_tstamp ASC
                  ) as last_geo_country
        
      
      
        from {{ ref('ecommerce_transaction_interactions_features_1_daily_aggregates')}}
        
      )
      
      select
          
        w.domain_userid,
        current_timestamp() as valid_at_tstamp,
        {{ lower_limit }} as lower_limit,
        cast({{ upper_limit }} as date) as upper_limit
      
        
      
        -- time window based attributes
        
          , page_view_count_last_7_days
        
          
        -- lifetime based attributes
        
      
        -- user lasts
        
          , w.last_geo_country
      
      from aggregations as a
      
      left join window_calculations as w
      on a.domain_userid = w.domain_userid
      
  
    ''',
    'ecommerce_transaction_interactions_features_1/models/base/manifest/ecommerce_transaction_interactions_features_1_incremental_manifest.sql': '''
      {#
      Copyright (c) 2025-present Snowplow Analytics Ltd. All rights reserved.
      This program is licensed to you under the Snowplow Personal and Academic License Version 1.0,
      and you may not use this file except in compliance with the Snowplow Personal and Academic License Version 1.0.
      You may obtain a copy of the Snowplow Personal and Academic License Version 1.0 at https://docs.snowplow.io/personal-and-academic-license-1.0/
      #}
      
      {{
        config(
          materialized='incremental',
          sql_header=snowplow_utils.set_query_tag(var('snowplow__query_tag', 'snowplow_dbt')),
          tblproperties={
            'delta.autoOptimize.optimizeWrite' : 'true',
            'delta.autoOptimize.autoCompact' : 'true'
          },
        )
      }}
      
      {% set incremental_manifest_query = snowplow_utils.base_create_snowplow_incremental_manifest_t() %}
      
      {{ incremental_manifest_query }}
      
      {# TODO: add full refresh in config! #}
  
    ''',
    'ecommerce_transaction_interactions_features_1/models/base/scratch/ecommerce_transaction_interactions_features_1_base_events_this_run.sql': '''
      {#
      Copyright (c) 2025-present Snowplow Analytics Ltd. All rights reserved.
      This program is licensed to you under the Snowplow Personal and Academic License Version 1.0,
      and you may not use this file except in compliance with the Snowplow Personal and Academic License Version 1.0.
      You may obtain a copy of the Snowplow Personal and Academic License Version 1.0 at https://docs.snowplow.io/personal-and-academic-license-1.0/
      #}
      
      {{
        config(
          sort='load_tstamp',
          dist='event_id',
          tags=["this_run"]
        )
      }}
      
      {% set base_events_query = snowplow_utils.base_create_snowplow_events_this_run_t(
                                    run_limits_table='ecommerce_transaction_interactions_features_1_base_new_event_limits',
                                    app_ids=var('snowplow__app_id', []),
                                    snowplow_events_database=var('snowplow__database', target.database) if target.type not in ['databricks', 'spark'] else var('snowplow__databricks_catalog', 'hive_metastore') if target.type in ['databricks'] else var('snowplow__atomic_schema', 'atomic'),
                                    snowplow_events_schema=var('snowplow__atomic_schema', 'atomic'),
                                    snowplow_events_table=var('snowplow__events_table', 'events'),
                                    event_names=var('snowplow__events_to_include', [])
                                    ) %}
      
      {{ base_events_query }}
  
    ''',
    'ecommerce_transaction_interactions_features_1/models/base/scratch/ecommerce_transaction_interactions_features_1_base_new_event_limits.sql': '''
      
      {#
      Copyright (c) 2025-present Snowplow Analytics Ltd. All rights reserved.
      This program is licensed to you under the Snowplow Personal and Academic License Version 1.0,
      and you may not use this file except in compliance with the Snowplow Personal and Academic License Version 1.0.
      You may obtain a copy of the Snowplow Personal and Academic License Version 1.0 at https://docs.snowplow.io/personal-and-academic-license-1.0/
      #}
      
      {{ config(
         post_hook=["{{snowplow_utils.print_run_limits(this, 'ecommerce_transaction_interactions_features_1')}}"],
         sql_header=snowplow_utils.set_query_tag(var('snowplow__query_tag', 'snowplow_dbt'))
         )
      }}
      
      
      {%- set models_in_run = snowplow_utils.get_enabled_snowplow_models('ecommerce_transaction_interactions_features_1', base_events_table_name='ecommerce_transaction_interactions_features_1_snowplow_base_events_this_run') -%}
      
      {% set min_first_processed_load_tstamp,
            max_first_processed_load_tstamp,
            min_last_processed_load_tstamp,
            max_last_processed_load_tstamp,
            models_matched_from_manifest,
            sync_count,
            has_matched_all_models = snowplow_utils.get_incremental_manifest_status_t(ref('ecommerce_transaction_interactions_features_1_incremental_manifest'),
                                                                                       models_in_run) -%}
      
      {% set run_limits_query = snowplow_utils.get_run_limits_t(min_first_processed_load_tstamp,
                                                               max_first_processed_load_tstamp,
                                                               min_last_processed_load_tstamp,
                                                               max_last_processed_load_tstamp,
                                                               models_matched_from_manifest,
                                                               sync_count,
                                                               has_matched_all_models,
                                                               var("snowplow__start_date","2024-01-01")) -%}
      
      {{ run_limits_query }}
  
    ''',
    'ecommerce_transaction_interactions_features_1/models/daily_aggregates/ecommerce_transaction_interactions_features_1_daily_aggregates.sql': '''
      
      {#
      Copyright (c) 2025-present Snowplow Analytics Ltd. All rights reserved.
      This program is licensed to you under the Snowplow Personal and Academic License Version 1.0,
      and you may not use this file except in compliance with the Snowplow Personal and Academic License Version 1.0.
      You may obtain a copy of the Snowplow Personal and Academic License Version 1.0 at https://docs.snowplow.io/personal-and-academic-license-1.0/
      #}
      
      {{
        config(
          materialized='incremental',
          sort='event_date',
          dist='domain_userid',
          partition_by = snowplow_utils.get_value_by_target_type(bigquery_val = {
            "field": "event_date",
            "data_type": "date"
          }, databricks_val='event_date'),
          unique_key='user_date_id',
          upsert_date_key='event_date',
          tags=["derived"],
          on_schema_change='append_new_columns',
          cluster_by=snowplow_utils.get_value_by_target_type(bigquery_val=["event_date","domain_userid"], snowflake_val=["event_date"]),
          sql_header=snowplow_utils.set_query_tag(var('snowplow__query_tag', 'snowplow_dbt')),
          tblproperties={
            'delta.autoOptimize.optimizeWrite' : 'true',
            'delta.autoOptimize.autoCompact' : 'true'
          },
          snowplow_optimize = true
        )
      }}
      
      select * from
      {{ ref('ecommerce_transaction_interactions_features_1_daily_aggregates_this_run') }}
  
    ''',
    'ecommerce_transaction_interactions_features_1/models/daily_aggregates/manifest/ecommerce_transaction_interactions_features_1_daily_aggregation_manifest.sql': '''
      
      {#
      Copyright (c) 2025-present Snowplow Analytics Ltd. All rights reserved.
      This program is licensed to you under the Snowplow Personal and Academic License Version 1.0,
      and you may not use this file except in compliance with the Snowplow Personal and Academic License Version 1.0.
      You may obtain a copy of the Snowplow Personal and Academic License Version 1.0 at https://docs.snowplow.io/personal-and-academic-license-1.0/
      #}
      
      {#
          Dynamic manifest that tracks all daily metrics models.
          Dependencies must be declared statically for dbt's DAG.
      #}
      
      -- depends_on: {{ ref('ecommerce_transaction_interactions_features_1_daily_aggregates_this_run') }}
      -- depends_on: {{ ref('ecommerce_transaction_interactions_features_1_filtered_events_this_run') }}
      -- depends_on: {{ ref('ecommerce_transaction_interactions_features_1_filtered_events') }}
      -- depends_on: {{ ref('ecommerce_transaction_interactions_features_1_daily_aggregates') }}
      
      {{
          config(
              materialized='incremental',
              unique_key=['event_date', 'source_model'],
              on_schema_change='sync_all_columns',
              sql_header=snowplow_utils.set_query_tag(var('snowplow__query_tag', 'snowplow_dbt')))
      }}
      
      {% set daily_aggregation_manifest_query = snowplow_utils.create_daily_aggregation_manifest('ecommerce_transaction_interactions_features_1') %}
      
      {{ daily_aggregation_manifest_query }}
      
       
    ''',
    'ecommerce_transaction_interactions_features_1/models/daily_aggregates/scratch/ecommerce_transaction_interactions_features_1_daily_aggregates_this_run.sql': '''
      
      {#Copyright (c) 2025-present Snowplow Analytics Ltd. All rights reserved.
      This program is licensed to you under the Snowplow Personal and Academic License Version 1.0,
      and you may not use this file except in compliance with the Snowplow Personal and Academic License Version 1.0.
      You may obtain a copy of the Snowplow Personal and Academic License Version 1.0 at https://docs.snowplow.io/personal-and-academic-license-1.0/
      #}
      
      {{
          config(
              tags=["this_run"],
              materialized="table",
              sql_header=snowplow_utils.set_query_tag(var('snowplow__query_tag', 'snowplow_dbt')),
              unique_key=['user_date_id']
          )
      }}
      
      with events as (
        select e.* 
        from {{ ref('ecommerce_transaction_interactions_features_1_filtered_events') }} e
        inner join {{ ref('ecommerce_transaction_interactions_features_1_days_to_process') }} d
            on date(e.derived_tstamp) = d.event_date
      )
      
      , aggregations as (
        
        select
          {{ dbt_utils.generate_surrogate_key(['domain_userid', 'event_date']) }} user_date_id,
          domain_userid,
          event_date
          
          
            ,count(case when  event_name IN('page_view') then 1 else 0 end) as count_page_view
          
          
        from events
        group by 1,2,3
      )
      
      --TODO: consider separating them to user_lasts and user_firsts to avoid having to do multiple window functions if these fields get bigger and the query optimizer does not catch them
      , window_calculations as (
        
        select
          *,
          last_value(derived_tstamp) over (partition by user_date_id order by derived_tstamp) as last_event_tstamp
              
          
          
            , last_value(geo_country) over (partition by user_date_id order by derived_tstamp) as last_geo_country
        
        from events
        
      )
      
      select distinct
        a.user_date_id,
        a.domain_userid,
        a.event_date,
        w.last_event_tstamp
      
          
          , a.count_page_view
        
        
          
        
          
          , w.last_geo_country
      
      from aggregations a
      
      left join window_calculations w
      on w.user_date_id = a.user_date_id
      
  
    ''',
    'ecommerce_transaction_interactions_features_1/models/daily_aggregates/scratch/ecommerce_transaction_interactions_features_1_days_to_process.sql': '''
      
      {#
      Copyright (c) 2023-present Snowplow Analytics Ltd. All rights reserved.
      This program is licensed to you under the Snowplow Personal and Academic License Version 1.0,
      and you may not use this file except in compliance with the Snowplow Personal and Academic License Version 1.0.
      You may obtain a copy of the Snowplow Personal and Academic License Version 1.0 at https://docs.snowplow.io/personal-and-academic-license-1.0/
      #}
      
      {{
          config(
              materialized='table',
              tags=['snowplow_autogen', 'dates_to_process'],
              sql_header=snowplow_utils.set_query_tag(var('snowplow__query_tag', 'snowplow_dbt')),
              post_hook=[
                  "{{ snowplow_utils.print_dates_to_process() }}"
              ]
          )
      }}
      
      {% set dates_to_process_query = snowplow_utils.get_dates_to_process(
          'ecommerce_transaction_interactions_features_1_filtered_events_this_run',
          'ecommerce_transaction_interactions_features_1_daily_aggregation_manifest'
      ) %}
      
      {{ dates_to_process_query }}
  
    ''',
    'ecommerce_transaction_interactions_features_1/models/filtered_events/ecommerce_transaction_interactions_features_1_filtered_events.sql': '''
      
      {#
      Copyright (c) 2025-present Snowplow Analytics Ltd. All rights reserved.
      This program is licensed to you under the Snowplow Personal and Academic License Version 1.0,
      and you may not use this file except in compliance with the Snowplow Personal and Academic License Version 1.0.
      You may obtain a copy of the Snowplow Personal and Academic License Version 1.0 at https://docs.snowplow.io/personal-and-academic-license-1.0/
      #}
      {{ config(
          materialized = "incremental",
          unique_key = "event_id",
          upsert_date_key = "derived_tstamp",
          partition_by = snowplow_utils.get_value_by_target_type(
              bigquery_val={
              "field": "derived_tstamp",
              "data_type": "timestamp"
          }, 
          databricks_val='derived_tstamp_date'),
          sql_header=snowplow_utils.set_query_tag(var('snowplow__query_tag', 'snowplow_dbt')),
          tblproperties={
            'delta.autoOptimize.optimizeWrite' : 'true',
            'delta.autoOptimize.autoCompact' : 'true'
          },
          snowplow_optimize=true
      ) }}
      
      select *
          
      from {{ ref('ecommerce_transaction_interactions_features_1_filtered_events_this_run') }}
      where {{ snowplow_utils.is_run_with_new_events("ecommerce_transaction_interactions_features_1"
              , new_event_limits_table="ecommerce_transaction_interactions_features_1_base_new_event_limits"
              , incremental_manifest_table="ecommerce_transaction_interactions_features_1_incremental_manifest"
              , base_sessions_lifecycle_table="ecommerce_transaction_interactions_features_1_base_sessions_lifecycle"
              ) }}
  
    ''',
    'ecommerce_transaction_interactions_features_1/models/filtered_events/scratch/ecommerce_transaction_interactions_features_1_filtered_events_this_run.sql': '''
      {#
      Copyright (c) 2025-present Snowplow Analytics Ltd. All rights reserved.
      This program is licensed to you under the Snowplow Personal and Academic License Version 1.0,
      and you may not use this file except in compliance with the Snowplow Personal and Academic License Version 1.0.
      You may obtain a copy of the Snowplow Personal and Academic License Version 1.0 at https://docs.snowplow.io/personal-and-academic-license-1.0/
      #}
      
      {{
          config(
              tags=["this_run"],
              materialized="table",
              sql_header=snowplow_utils.set_query_tag(var('snowplow__query_tag', 'snowplow_dbt'))
          )
      }}
      
      select
          event_id,
          domain_userid,
          derived_tstamp,
          date(derived_tstamp) as event_date,
          load_tstamp,
          {{ dbt_utils.generate_surrogate_key(['domain_userid', 'event_date']) }} AS user_date_id,
          event_name,
          geo_country AS geo_country
          
      
      from
          {{ ref('ecommerce_transaction_interactions_features_1_base_events_this_run') }}
      where 
          (event_name = 'page_view'
              and event_vendor = 'com.snowplowanalytics.snowplow'
              and event_version = '1-0-0'
          )
      
      
          
          and {{ snowplow_utils.is_run_with_new_events("ecommerce_transaction_interactions_features_1"
              , new_event_limits_table="ecommerce_transaction_interactions_features_1_base_new_event_limits"
              , incremental_manifest_table="ecommerce_transaction_interactions_features_1_incremental_manifest"
              , base_sessions_lifecycle_table="ecommerce_transaction_interactions_features_1_base_sessions_lifecycle"
              ) }}
      
  
    ''',
    'ecommerce_transaction_interactions_features_1/packages.yml': '''
      
      packages:
        - git: "https://github.com/snowplow/dbt-snowplow-utils.git"
          revision: "refactor/time-based-macros"
  
    ''',
  })
# ---
